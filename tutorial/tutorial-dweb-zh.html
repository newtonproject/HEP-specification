<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>网站DApp网站开发指南 | HEP-specification</title>
    <meta name="description" content="HEP(Hyper Exchange Protocol) Specification for DApp development in Newton ecosystem">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/HEP-specification/assets/css/0.styles.ba461f21.css" as="style"><link rel="preload" href="/HEP-specification/assets/js/app.419242cf.js" as="script"><link rel="preload" href="/HEP-specification/assets/js/2.810d226b.js" as="script"><link rel="preload" href="/HEP-specification/assets/js/53.e66884bb.js" as="script"><link rel="preload" href="/HEP-specification/assets/js/3.aada4df1.js" as="script"><link rel="prefetch" href="/HEP-specification/assets/js/10.07b5122b.js"><link rel="prefetch" href="/HEP-specification/assets/js/11.07ab2f5a.js"><link rel="prefetch" href="/HEP-specification/assets/js/12.ccd7c691.js"><link rel="prefetch" href="/HEP-specification/assets/js/13.590ca748.js"><link rel="prefetch" href="/HEP-specification/assets/js/14.2d893eb2.js"><link rel="prefetch" href="/HEP-specification/assets/js/15.b78077ba.js"><link rel="prefetch" href="/HEP-specification/assets/js/16.7829fee6.js"><link rel="prefetch" href="/HEP-specification/assets/js/17.0d23eaee.js"><link rel="prefetch" href="/HEP-specification/assets/js/18.fda3c910.js"><link rel="prefetch" href="/HEP-specification/assets/js/19.388dc885.js"><link rel="prefetch" href="/HEP-specification/assets/js/20.bd33d416.js"><link rel="prefetch" href="/HEP-specification/assets/js/21.fec79911.js"><link rel="prefetch" href="/HEP-specification/assets/js/22.4852e8c3.js"><link rel="prefetch" href="/HEP-specification/assets/js/23.02ca9ad2.js"><link rel="prefetch" href="/HEP-specification/assets/js/24.a27ecedb.js"><link rel="prefetch" href="/HEP-specification/assets/js/25.6d591597.js"><link rel="prefetch" href="/HEP-specification/assets/js/26.5b54232e.js"><link rel="prefetch" href="/HEP-specification/assets/js/27.db582809.js"><link rel="prefetch" href="/HEP-specification/assets/js/28.6fe812df.js"><link rel="prefetch" href="/HEP-specification/assets/js/29.e2c1a4a5.js"><link rel="prefetch" href="/HEP-specification/assets/js/30.c8bfc05d.js"><link rel="prefetch" href="/HEP-specification/assets/js/31.efd4bdf8.js"><link rel="prefetch" href="/HEP-specification/assets/js/32.8e817237.js"><link rel="prefetch" href="/HEP-specification/assets/js/33.5124ac4c.js"><link rel="prefetch" href="/HEP-specification/assets/js/34.425f35bd.js"><link rel="prefetch" href="/HEP-specification/assets/js/35.102079c4.js"><link rel="prefetch" href="/HEP-specification/assets/js/36.476ac90a.js"><link rel="prefetch" href="/HEP-specification/assets/js/37.04ff4ab5.js"><link rel="prefetch" href="/HEP-specification/assets/js/38.7da043dd.js"><link rel="prefetch" href="/HEP-specification/assets/js/39.b6051c5a.js"><link rel="prefetch" href="/HEP-specification/assets/js/4.65a1a4c3.js"><link rel="prefetch" href="/HEP-specification/assets/js/40.0f513e54.js"><link rel="prefetch" href="/HEP-specification/assets/js/41.d680db47.js"><link rel="prefetch" href="/HEP-specification/assets/js/42.5bf0e2d1.js"><link rel="prefetch" href="/HEP-specification/assets/js/43.1d061f75.js"><link rel="prefetch" href="/HEP-specification/assets/js/44.f794bd6d.js"><link rel="prefetch" href="/HEP-specification/assets/js/45.c060c4a9.js"><link rel="prefetch" href="/HEP-specification/assets/js/46.60bf6604.js"><link rel="prefetch" href="/HEP-specification/assets/js/47.88292d12.js"><link rel="prefetch" href="/HEP-specification/assets/js/48.f9953027.js"><link rel="prefetch" href="/HEP-specification/assets/js/49.79770fab.js"><link rel="prefetch" href="/HEP-specification/assets/js/5.11a4bfaf.js"><link rel="prefetch" href="/HEP-specification/assets/js/50.c47ea8c2.js"><link rel="prefetch" href="/HEP-specification/assets/js/51.f7c689e5.js"><link rel="prefetch" href="/HEP-specification/assets/js/52.081ff357.js"><link rel="prefetch" href="/HEP-specification/assets/js/54.6884c4e5.js"><link rel="prefetch" href="/HEP-specification/assets/js/55.e1ad1900.js"><link rel="prefetch" href="/HEP-specification/assets/js/56.0bb83b11.js"><link rel="prefetch" href="/HEP-specification/assets/js/57.f85086c4.js"><link rel="prefetch" href="/HEP-specification/assets/js/58.2d1f834a.js"><link rel="prefetch" href="/HEP-specification/assets/js/59.18855501.js"><link rel="prefetch" href="/HEP-specification/assets/js/6.ee814126.js"><link rel="prefetch" href="/HEP-specification/assets/js/7.cfd8f4f1.js"><link rel="prefetch" href="/HEP-specification/assets/js/8.01bf51c2.js"><link rel="prefetch" href="/HEP-specification/assets/js/9.849c036f.js">
    <link rel="stylesheet" href="/HEP-specification/assets/css/0.styles.ba461f21.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/HEP-specification/" class="home-link router-link-active"><!----> <span class="site-name">HEP-specification</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/HEP-specification/" class="nav-link">
  home
</a></div><div class="nav-item"><a href="/HEP-specification/hep-node/" class="nav-link">
  hep-node
</a></div><div class="nav-item"><a href="/HEP-specification/oracle/oracle.html" class="nav-link">
  oracle
</a></div><div class="nav-item"><a href="https://github.com/newtonproject/HEP-specification" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/HEP-specification/" class="nav-link">
  home
</a></div><div class="nav-item"><a href="/HEP-specification/hep-node/" class="nav-link">
  hep-node
</a></div><div class="nav-item"><a href="/HEP-specification/oracle/oracle.html" class="nav-link">
  oracle
</a></div><div class="nav-item"><a href="https://github.com/newtonproject/HEP-specification" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/HEP-specification/" class="sidebar-link">home</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/HEP-specification/#hep-ecosystem" class="sidebar-link">HEP Ecosystem</a></li><li class="sidebar-sub-header"><a href="/HEP-specification/#architecture" class="sidebar-link">Architecture</a></li><li class="sidebar-sub-header"><a href="/HEP-specification/#building-your-dapp" class="sidebar-link">Building your Dapp</a></li></ul></li><li><a href="/HEP-specification/oracle/oracle.html" class="sidebar-link">oracle</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/HEP-specification/oracle/oracle.html#why" class="sidebar-link">Why?</a></li><li class="sidebar-sub-header"><a href="/HEP-specification/oracle/oracle.html#how" class="sidebar-link">How?</a></li></ul></li><li><a href="/HEP-specification/DWeb.html" class="sidebar-link">DWeb</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/HEP-specification/DWeb.html#user-account-creation-and-login" class="sidebar-link">User Account Creation and Login</a></li><li class="sidebar-sub-header"><a href="/HEP-specification/DWeb.html#payments" class="sidebar-link">Payments</a></li><li class="sidebar-sub-header"><a href="/HEP-specification/DWeb.html#placeorder" class="sidebar-link">PlaceOrder</a></li></ul></li><li><a href="/HEP-specification/tutorial/" class="sidebar-link">Tutorial</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="网站dapp网站开发指南"><a href="#网站dapp网站开发指南" class="header-anchor">#</a> 网站DApp网站开发指南</h1> <p>网站DApp提供Python、PHP、Java编程语言SDK。根据开发需要，选择不同版本的SDK。</p> <h2 id="安装sdk"><a href="#安装sdk" class="header-anchor">#</a> 安装SDK</h2> <h3 id="python-sdk"><a href="#python-sdk" class="header-anchor">#</a> python SDK</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>pip <span class="token function">install</span> hep-rest-api
</code></pre></div><h3 id="php"><a href="#php" class="header-anchor">#</a> PHP</h3> <p><a href="/HEP-specification/tutorial/tutorial\tutorial-dweb-zh-php.html">PHP Tutorial</a></p> <h3 id="java"><a href="#java" class="header-anchor">#</a> Java</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>TBD
</code></pre></div><h2 id="步骤"><a href="#步骤" class="header-anchor">#</a> 步骤</h2> <h3 id="生成dapp公私钥对"><a href="#生成dapp公私钥对" class="header-anchor">#</a> 生成DApp公私钥对</h3> <h3 id="创建dapp"><a href="#创建dapp" class="header-anchor">#</a> 创建DApp</h3> <p>TBD</p> <h3 id="基础参数配置"><a href="#基础参数配置" class="header-anchor">#</a> 基础参数配置</h3> <ul><li>Python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> sys

<span class="token comment"># 配置基础参数</span>
HEP_HOST <span class="token operator">=</span> <span class="token string">&quot;https://hep.testnet.newtonproject.org&quot;</span> <span class="token comment"># testnet url</span>
DAPP_ID <span class="token operator">=</span> <span class="token string">&quot;{dapp_id}&quot;</span>
DAPP_KEY <span class="token operator">=</span> <span class="token string">&quot;{dapp_key}&quot;</span>
DAPP_SECERT <span class="token operator">=</span> <span class="token string">&quot;{dapp_secret}&quot;</span>
DAPP_PRIVATE_KEY_PATH <span class="token operator">=</span> <span class="token string">&quot;{dapp_private_key_path}&quot;</span>
DAPP_PROTOCOL <span class="token operator">=</span> <span class="token string">&quot;HEP&quot;</span>
DAPP_PROTOCOL_VERSION <span class="token operator">=</span> <span class="token string">&quot;1.0&quot;</span>
CHAIN_ID <span class="token operator">=</span> <span class="token number">1012</span>  <span class="token comment"># dev environment is 1002, test environment is 1002, mainnet environment is 1012</span>

<span class="token comment"># ACTION 参数</span>
ACTION_LOGIN <span class="token operator">=</span> <span class="token string">&quot;hep.auth.login&quot;</span>
ACTION_PAY <span class="token operator">=</span> <span class="token string">&quot;hep.pay.order&quot;</span>
ACTION_PROOF_SUBMIT <span class="token operator">=</span> <span class="token string">&quot;hep.proof.submit&quot;</span>

<span class="token comment"># 基础配置信息</span>
base_parameters <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'dapp_key'</span><span class="token punctuation">:</span> DAPP_KEY<span class="token punctuation">,</span>
    <span class="token string">'protocol'</span><span class="token punctuation">:</span> DAPP_PROTOCOL<span class="token punctuation">,</span>
    <span class="token string">'version'</span><span class="token punctuation">:</span> DAPP_PROTOCOL_VERSION<span class="token punctuation">,</span>
    <span class="token string">'os'</span><span class="token punctuation">:</span> sys<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
    <span class="token string">'language'</span><span class="token punctuation">:</span> <span class="token string">'en'</span> <span class="token comment"># Your language</span>
<span class="token punctuation">}</span>

<span class="token comment">## 创建api client</span>
configuration <span class="token operator">=</span> hep_rest_api<span class="token punctuation">.</span>api_client<span class="token punctuation">.</span>Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span>
configuration<span class="token punctuation">.</span>host <span class="token operator">=</span> HEP_HOST
api_client <span class="token operator">=</span> hep_rest_api<span class="token punctuation">.</span>RestApi<span class="token punctuation">(</span>hep_rest_api<span class="token punctuation">.</span>ApiClient<span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>javascript 基础定义</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>newtonproject<span class="token operator">/</span><span class="token constant">HEP</span><span class="token operator">-</span>specification<span class="token operator">/</span>blob<span class="token operator">/</span>master<span class="token operator">/</span>hep<span class="token operator">-</span>provider<span class="token operator">/</span>user<span class="token operator">-</span>agent<span class="token punctuation">.</span>md
</code></pre></div><h3 id="newid授权"><a href="#newid授权" class="header-anchor">#</a> NewID授权</h3> <h4 id="初始化授权helper"><a href="#初始化授权helper" class="header-anchor">#</a> 初始化授权Helper</h4> <ul><li>python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>auth_helper <span class="token operator">=</span> AuthHelper<span class="token punctuation">(</span>_get_api_client<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> base_parameters<span class="token punctuation">,</span> DAPP_ID<span class="token punctuation">,</span> DAPP_SECERT<span class="token punctuation">,</span> DAPP_PRIVATE_KEY_PATH<span class="token punctuation">,</span> chain_id<span class="token operator">=</span>CHAIN_ID<span class="token punctuation">)</span>
</code></pre></div><h4 id="生成授权签名"><a href="#生成授权签名" class="header-anchor">#</a> 生成授权签名</h4> <ul><li>python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>session_id <span class="token operator">=</span> <span class="token string">'{session_id}'</span><span class="token punctuation">:</span> <span class="token comment"># 会话标识</span>
auth_response <span class="token operator">=</span> auth_helper<span class="token punctuation">.</span>generate_auth_request<span class="token punctuation">(</span>uuid<span class="token operator">=</span>session_id<span class="token punctuation">)</span>
</code></pre></div><h4 id="pc网站生成qrcode"><a href="#pc网站生成qrcode" class="header-anchor">#</a> PC网站生成QRCode</h4> <ul><li>python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>qr_code_str <span class="token operator">=</span> auth_helper<span class="token punctuation">.</span>generate_qrcode_string<span class="token punctuation">(</span>auth_response<span class="token punctuation">.</span>auth_hash<span class="token punctuation">)</span>
</code></pre></div><h4 id="移动网站调用内置javascript函数，回调的数据结构"><a href="#移动网站调用内置javascript函数，回调的数据结构" class="header-anchor">#</a> 移动网站调用内置Javascript函数，<a href="https://github.com/newtonproject/HEP-specification/blob/master/interact-specification/DWeb-callback-error-messages.md#example">回调的数据结构</a></h4> <ul><li>获取登录参数，并且传递参数到 NewPay, 获取 profile 信息</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">h5login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;/request/login/h5/&quot;</span><span class="token punctuation">;</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> url<span class="token punctuation">,</span>
        async<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error_code <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> params <span class="token operator">=</span> res<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>hep<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 确保 newpay 注入成功，由 NewPay 完成</span>
                    hep<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">var</span> profile <span class="token operator">=</span> response<span class="token punctuation">.</span>result<span class="token punctuation">;</span>   <span class="token comment">// 成功的结果数据</span>
                            <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;/post/profile/&quot;</span><span class="token punctuation">;</span>
                            $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error_code <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/user&quot;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token function">alert</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 错误信息</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;hep is not inject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="使用newpay完成授权，将授权数据发送到网站回调接口"><a href="#使用newpay完成授权，将授权数据发送到网站回调接口" class="header-anchor">#</a> 使用NewPay完成授权，将授权数据发送到网站回调接口</h4> <p>callback的接受参数格式见 https://github.com/newtonproject/HEP-specification/blob/master/interact-specification/DWeb-NewPay.md#newpay-return-to-dweb-app-or-server</p> <h4 id="网站验证用户返回授权数据"><a href="#网站验证用户返回授权数据" class="header-anchor">#</a> 网站验证用户返回授权数据</h4> <ul><li>python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 如果返回为 True， 那么用户的信息已确认</span>
verify_status <span class="token operator">=</span> auth_helper<span class="token punctuation">.</span>validate_auth_callback<span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token keyword">from</span> hep_rest_api<span class="token punctuation">.</span>scenarios<span class="token punctuation">.</span>auth <span class="token keyword">import</span> AuthHelper
<span class="token keyword">from</span> hep_rest_api<span class="token punctuation">.</span>scenarios<span class="token punctuation">.</span>pay <span class="token keyword">import</span> PayHelper
<span class="token keyword">from</span> hep_rest_api<span class="token punctuation">.</span>scenarios<span class="token punctuation">.</span>proof <span class="token keyword">import</span> ProofHelper
</code></pre></div><h4 id="接收成功-返回-http-code-为-200，其他-code-为失败"><a href="#接收成功-返回-http-code-为-200，其他-code-为失败" class="header-anchor">#</a> 接收成功 返回 http code 为 200，其他 code 为失败</h4> <h2 id="支付"><a href="#支付" class="header-anchor">#</a> 支付</h2> <h4 id="获取支付的-payhelper"><a href="#获取支付的-payhelper" class="header-anchor">#</a> 获取支付的 PayHelper</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_get_pay_helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> pay_helper<span class="token punctuation">:</span>
        <span class="token keyword">return</span> pay_helper
    <span class="token keyword">return</span> PayHelper<span class="token punctuation">(</span>_get_api_client<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> base_parameters<span class="token punctuation">,</span> DAPP_ID<span class="token punctuation">,</span> DAPP_SECERT<span class="token punctuation">,</span> DAPP_PRIVATE_KEY_PATH<span class="token punctuation">,</span> chain_id<span class="token operator">=</span>CHAIN_ID<span class="token punctuation">)</span>
</code></pre></div><h4 id="生成支付签名"><a href="#生成支付签名" class="header-anchor">#</a> 生成支付签名</h4> <ul><li>python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'orderInformation'</span><span class="token punctuation">}</span>
pay_response <span class="token operator">=</span> pay_helper<span class="token punctuation">.</span>generate_pay_request<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre></div><h4 id="pc网站生成qrcode-2"><a href="#pc网站生成qrcode-2" class="header-anchor">#</a> PC网站生成QRCode</h4> <ul><li>python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>qr_code_str <span class="token operator">=</span> pay_helper<span class="token punctuation">.</span>generate_qrcode_string<span class="token punctuation">(</span>pay_helper<span class="token punctuation">.</span>pay_hash<span class="token punctuation">)</span>
</code></pre></div><h4 id="移动网站调用内置javascript函数"><a href="#移动网站调用内置javascript函数" class="header-anchor">#</a> 移动网站调用内置Javascript函数</h4> <ul><li>获取支付参数，并且传递支付参数到 NewPay, 获取支付结果信息</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">h5pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;/request/pay/h5/&quot;</span><span class="token punctuation">;</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> url<span class="token punctuation">,</span>
        async<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">'order_number'</span><span class="token operator">:</span> <span class="token string">'orderNumber'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error_code <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>hep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> params <span class="token operator">=</span> res<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
                    hep<span class="token punctuation">.</span>pay<span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">var</span> pay_info <span class="token operator">=</span> response<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
                            <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;/receive/pay/&quot;</span><span class="token punctuation">;</span>
                            $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                url<span class="token operator">:</span> url<span class="token punctuation">,</span>
                                async<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                type<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
                                data<span class="token operator">:</span> pay_info<span class="token punctuation">,</span>
                                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error_code <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/placeorder/&quot;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token function">alert</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;hep is not inject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="使用newpay完成支付，将支付数据发送到网站回调接口"><a href="#使用newpay完成支付，将支付数据发送到网站回调接口" class="header-anchor">#</a> 使用NewPay完成支付，将支付数据发送到网站回调接口</h4> <p>callback的接受参数格式见 https://github.com/newtonproject/HEP-specification/blob/master/interact-specification/DWeb-NewPay.md#return-transaction-information-to-dapp-js-or-server</p> <h4 id="网站验证用户返回支付数据"><a href="#网站验证用户返回支付数据" class="header-anchor">#</a> 网站验证用户返回支付数据</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">verify_pay</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 验证签名是否通过</span>
    is_valid <span class="token operator">=</span> _get_pay_helper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>validate_pay_callback<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token keyword">if</span> is_valid<span class="token punctuation">:</span>
        <span class="token comment"># 根据txid获取确认的订单信息，返回结果包括 订单唯一编号，支付接受地址，支付发送方地址，支付金额等</span>
        response <span class="token operator">=</span> _get_pay_helper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_confirmed_transaction<span class="token punctuation">(</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'txid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 参见: https://github.com/newtonproject/HEP-specification/blob/master/hep-protocol/README.md#return-transaction-information-to-dapp</span>
        <span class="token keyword">return</span> response
    <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre></div><h4 id="接收成功-返回-http-code-为-200，其他-code-均为失败"><a href="#接收成功-返回-http-code-为-200，其他-code-均为失败" class="header-anchor">#</a> 接收成功 返回 http code 为 200，其他 code 均为失败</h4> <h2 id="上链"><a href="#上链" class="header-anchor">#</a> 上链</h2> <h4 id="获取上链的-proofhelper"><a href="#获取上链的-proofhelper" class="header-anchor">#</a> 获取上链的 ProofHelper</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_get_proof_helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> proof_helper<span class="token punctuation">:</span>
        <span class="token keyword">return</span> proof_helper
    <span class="token keyword">return</span> ProofHelper<span class="token punctuation">(</span>_get_api_client<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> base_parameters<span class="token punctuation">,</span> DAPP_ID<span class="token punctuation">,</span> DAPP_SECERT<span class="token punctuation">,</span> DAPP_PRIVATE_KEY_PATH<span class="token punctuation">,</span> chain_id<span class="token operator">=</span>CHAIN_ID<span class="token punctuation">)</span>
</code></pre></div><h4 id="生成上链签名"><a href="#生成上链签名" class="header-anchor">#</a> 生成上链签名</h4> <ul><li>python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>content <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'proofinformation'</span><span class="token punctuation">}</span>
uuid <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'session_id'</span><span class="token punctuation">}</span>
proof_response <span class="token operator">=</span> proof_helper<span class="token punctuation">.</span>generate_proof_request<span class="token punctuation">(</span>content<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span>
</code></pre></div><h4 id="pc网站生成qrcode-3"><a href="#pc网站生成qrcode-3" class="header-anchor">#</a> PC网站生成QRCode</h4> <ul><li>python</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>qr_code_str <span class="token operator">=</span> proof_helper<span class="token punctuation">.</span>generate_qrcode_string<span class="token punctuation">(</span>proof_response<span class="token punctuation">.</span>proof_hash<span class="token punctuation">)</span>
</code></pre></div><h4 id="移动网站调用内置javascript函数-2"><a href="#移动网站调用内置javascript函数-2" class="header-anchor">#</a> 移动网站调用内置Javascript函数</h4> <ul><li>获取上链的参数，并且传递上链参数到 NewPay</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">h5proof</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;/request/proof/h5/&quot;</span><span class="token punctuation">;</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> url<span class="token punctuation">,</span>
        async<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">'order_number'</span><span class="token operator">:</span> <span class="token string">'orderNumber'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error_code <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>hep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> params <span class="token operator">=</span> res<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
                    hep<span class="token punctuation">.</span>proof<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">var</span> proof_info <span class="token operator">=</span> response<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
                            <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;/receive/proof/&quot;</span><span class="token punctuation">;</span>
                            $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                url<span class="token operator">:</span> url<span class="token punctuation">,</span>
                                async<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                type<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
                                data<span class="token operator">:</span> proof_info<span class="token punctuation">,</span>
                                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#tip'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token function">alert</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;hep is not inject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="使用newpay完成上链，将支付数据发送到网站回调接口"><a href="#使用newpay完成上链，将支付数据发送到网站回调接口" class="header-anchor">#</a> 使用NewPay完成上链，将支付数据发送到网站回调接口</h4> <p>callback的接受参数格式见 https://github.com/newtonproject/HEP-specification/blob/master/interact-specification/DWeb-NewPay.md#result-to-dweb-app-or-server</p> <h4 id="网站验证用户返回上链数据"><a href="#网站验证用户返回上链数据" class="header-anchor">#</a> 网站验证用户返回上链数据</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">verify_proof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 验证上链信息的签名</span>
    is_valid <span class="token operator">=</span> _get_proof_helper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>validate_proof_callback<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> is_valid<span class="token punctuation">:</span>
        <span class="token comment"># 可以批量验证 proof_hash 的状态</span>
        proof_hashes <span class="token operator">=</span> <span class="token punctuation">[</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'proof_hash'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        response <span class="token operator">=</span> _get_proof_helper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_status_of_proofs<span class="token punctuation">(</span>proof_hashes<span class="token punctuation">)</span>
        <span class="token comment"># 如果只校验一条的话取第一个数组的值，返回结果包括 proof_hash, 和 proof_status</span>
        <span class="token comment"># proof_status 为字符串类型 SUBMIT(已提交), PROCESSING(处理中),CONFIRMED(已上链), CANCELED(已取消), PART_CANCELED(部分取消/退货)</span>
        <span class="token comment"># 参见 https://github.com/newtonproject/HEP-specification/blob/master/hep-node/REST-API.md#proof_getproofreceipts</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>receipts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre></div><h4 id="接收成功-返回-http-code-为-200，其他-code-均为失败-2"><a href="#接收成功-返回-http-code-为-200，其他-code-均为失败-2" class="header-anchor">#</a> 接收成功 返回 http code 为 200，其他 code 均为失败</h4></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/HEP-specification/assets/js/app.419242cf.js" defer></script><script src="/HEP-specification/assets/js/2.810d226b.js" defer></script><script src="/HEP-specification/assets/js/53.e66884bb.js" defer></script><script src="/HEP-specification/assets/js/3.aada4df1.js" defer></script>
  </body>
</html>
